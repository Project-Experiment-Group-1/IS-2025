import pandas as pd
from sklearn.model_selection import train_test_split
from sklearn.feature_extraction.text import CountVectorizer
from sklearn.naive_bayes import MultinomialNB
from sklearn.metrics import classification_report
import joblib

DATA_FILE = 'emotion_data.csv'
MODEL_FILE = 'emotion_model.pkl'

## Training
def train_model(data_path):
    try:
        df = pd.read_csv(data_path, encoding='utf-8') 
        print(f"✅ データ {data_path} を読み込みました。レコード数: {len(df)}")
    except FileNotFoundError:
        print(f"❌ エラー: ファイルが見つかりません。{data_path} が同じディレクトリにあるか確認してください。")
        return None, None
    except Exception as e:
        print(f"❌ データの読み込み中にエラーが発生しました: {e}")
        return None, None

    X = df['text']
    y = df['emotion']

    X_train = X
    y_train = y
    
    vectorizer = CountVectorizer()
    X_train_counts = vectorizer.fit_transform(X_train)
    
    print(f"語彙サイズ: {len(vectorizer.get_feature_names_out())}")
    
    model = MultinomialNB()
    model.fit(X_train_counts, y_train)

    joblib.dump((model, vectorizer), MODEL_FILE)
    print(f"モデルとVectorizerを {MODEL_FILE} に保存しました。")

    return model, vectorizer

## Prediction
def predict_emotion(text_input, model, vectorizer):
    if model is None or vectorizer is None:
        print("❌ モデルが学習されていないか、読み込まれていません。")
        return "判定不可"

    text_counts = vectorizer.transform([text_input])
    
    prediction = model.predict(text_counts)
    

    return prediction[0]


if __name__ == '__main__':
    
    trained_model, trained_vectorizer = train_model(DATA_FILE)

    print("\n" + "="*40)
    print(" 感情認識 (予測) モード")
    print("="*40)

    if trained_model and trained_vectorizer:
        
        while True:
            try:
                user_input = input("判定したいテキストを入力してください ('exit'で終了): ")
                
                if user_input.lower() == 'exit':
                    print(" 終了します。")
                    break
                
                if not user_input.strip():
                    continue

                result_emotion = predict_emotion(user_input, trained_model, trained_vectorizer)
                
                print(f"判定結果: **{result_emotion}**")
                
            except Exception as e:
                print(f"処理中にエラーが発生しました: {e}")
                break
